{
  "version": 3,
  "sources": [
    "../../../../../src/controller/api/commom.js"
  ],
  "names": [
    "get",
    "controller",
    "sword",
    "Decorator",
    "commonFun",
    "require",
    "Common",
    "Controller",
    "download",
    "filePath",
    "decodeURIComponent",
    "query",
    "dir",
    "key",
    "evidence",
    "targetPath",
    "base642String",
    "replace",
    "path",
    "sep",
    "fs",
    "existsSync",
    "fileName",
    "basename",
    "dirPath",
    "dirname",
    "ctx",
    "attachment",
    "root",
    "setTimeout",
    "service",
    "e",
    "logger",
    "error",
    "json",
    "code",
    "data",
    "fail",
    "downloadView",
    "set",
    "gzip"
  ],
  "mappings": "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",
  "sourcesContent": [
    "import send from 'koa-send';\r\nimport path from 'path';\r\nimport fs from 'fs';\r\n\r\nconst { get, controller } = sword.Decorator;\r\nconst commonFun = require('../../utils/commonFun.js');\r\n\r\n@controller('/api/common/download')\r\nclass Common extends sword.Controller {\r\n    @get('/')\r\n    async download() {\r\n        const filePath = decodeURIComponent(this.query.dir);\r\n        const key = decodeURIComponent(this.query.key);\r\n        const evidence = decodeURIComponent(this.query.evidence);\r\n        try {\r\n            const targetPath = commonFun.base642String(filePath).replace(/\\/|\\\\/g, path.sep);\r\n            if (fs.existsSync(targetPath)) {\r\n                const fileName = path.basename(targetPath);\r\n                const dirPath = path.dirname(targetPath);\r\n                this.ctx.attachment(targetPath);\r\n                await send(this.ctx, fileName, {\r\n                    root: dirPath\r\n                });\r\n                // 证据中心导出文件删除\r\n                if (evidence) {\r\n                    setTimeout(async () => {\r\n                        await sword.service('evidence-center.deletePack')({ key, path: filePath });\r\n                    }, 30000);\r\n                }\r\n            } else {\r\n                throw `File not found!  filePath:${decodeURIComponent(filePath)}`;\r\n            }\r\n        } catch (e) {\r\n            // 证据中心导出文件删除\r\n            if (evidence) {\r\n                await sword.service('evidence-center.deletePack')({ key, path: filePath });\r\n            }\r\n            sword.logger.error(e);\r\n            const json = {\r\n                code: 202,\r\n                data: false\r\n            };\r\n            this.fail(json);\r\n        }\r\n    }\r\n\r\n    @get('/absolute/view')\r\n    async downloadView() {\r\n        try {\r\n            const filePath = decodeURIComponent(this.query.dir);\r\n            const targetPath = commonFun.base642String(filePath).replace(/\\/|\\\\/g, path.sep);\r\n            if (fs.existsSync(targetPath)) {\r\n                const fileName = path.basename(targetPath);\r\n                const dirPath = path.dirname(targetPath);\r\n                this.ctx.set({\r\n                    'Accept-Ranges': 'bytes'\r\n                });\r\n                await send(this.ctx, fileName, {\r\n                    root: dirPath,\r\n                    gzip: false\r\n                });\r\n            } else {\r\n                throw `File not found!  filePath:${decodeURIComponent(filePath)}`;\r\n            }\r\n        } catch (e) {\r\n            sword.logger.error(e);\r\n            const json = {\r\n                code: 202,\r\n                data: false\r\n            };\r\n            this.fail(json);\r\n        }\r\n    }\r\n}\r\nexport default Common;\r\n"
  ],
  "file": "commom.js"
}